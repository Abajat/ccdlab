#!/usr/bin/env python

# from twisted.internet.protocol import Protocol, Factory, ServerFactory
# from twisted.application.internet import ClientService
# from twisted.application.service import Service
# from twisted.internet.endpoints import TCP4ServerEndpoint, TCP4ClientEndpoint, connectProtocol
# from twisted.protocols.basic import LineReceiver

# from os import linesep

import os, sys

from daemon import SimpleFactory, SimpleProtocol
from command import Command

class ArchonFakeProtocol(SimpleProtocol):
    def processMessage(self, string):
        # It will handle some generic messages and return pre-parsed Command object
        obj = self.object # Object holding the state

        if len(string) < 4:
            return

        ch = string[0]
        id = string[1:3]
        command = string[3:]

        reply = command

        print ">", ch, id, command

        if command == 'STATUS':
            reply = 'VALID=1 COUNT=23582 LOG=0 POWER=1 POWERGOOD=1 OVERHEAT=0 BACKPLANE_TEMP=32.250 P2V5_V=2.547 P2V5_I=2.925 P5V_V=5.002 P5V_I=2.752 P6V_V=5.933 P6V_I=0.038 N6V_V=-6.055 N6V_I=0.116 P17V_V=16.947 P17V_I=0.213 N17V_V=-17.086 N17V_I=0.090 P35V_V=34.951 P35V_I=0.031 N35V_V=0.000 N35V_I=0.000 P100V_V=0.000 P100V_I=0.000 N100V_V=0.000 N100V_I=0.000 USER_V=0.000 USER_I=-0.001 HEATER_V=27.898 HEATER_I=0.002 MOD2/TEMP=31.062 MOD2/TEMPA=-273.150016 MOD2/TEMPB=-273.150016 MOD2/TEMPC=-273.150016 MOD2/HEATERAOUTPUT=0.900 MOD2/HEATERBOUTPUT=0.900 MOD2/HEATERAP=0 MOD2/HEATERAI=0 MOD2/HEATERAD=0 MOD2/HEATERBP=0 MOD2/HEATERBI=0 MOD2/HEATERBD=0 MOD2/DINPUTS=00000000 MOD2/VCPU_OUTREG0=0 MOD2/VCPU_OUTREG1=0 MOD2/VCPU_OUTREG2=0 MOD2/VCPU_OUTREG3=0 MOD2/VCPU_OUTREG4=0 MOD2/VCPU_OUTREG5=0 MOD2/VCPU_OUTREG6=0 MOD2/VCPU_OUTREG7=0 MOD2/VCPU_OUTREG8=0 MOD2/VCPU_OUTREG9=0 MOD2/VCPU_OUTREG10=0 MOD2/VCPU_OUTREG11=0 MOD2/VCPU_OUTREG12=0 MOD2/VCPU_OUTREG13=0 MOD2/VCPU_OUTREG14=0 MOD2/VCPU_OUTREG15=0 MOD3/TEMP=29.750 MOD4/TEMP=31.687 MOD4/LVLC_V1=0.012 MOD4/LVLC_I1=-0.008 MOD4/LVLC_V2=0.012 MOD4/LVLC_I2=0.002 MOD4/LVLC_V3=0.004 MOD4/LVLC_I3=0.006 MOD4/LVLC_V4=-0.009 MOD4/LVLC_I4=-0.006 MOD4/LVLC_V5=-0.002 MOD4/LVLC_I5=-0.013 MOD4/LVLC_V6=0.002 MOD4/LVLC_I6=-0.003 MOD4/LVLC_V7=-0.006 MOD4/LVLC_I7=0.003 MOD4/LVLC_V8=0.012 MOD4/LVLC_I8=-0.010 MOD4/LVLC_V9=0.017 MOD4/LVLC_I9=-0.011 MOD4/LVLC_V10=0.008 MOD4/LVLC_I10=-0.011 MOD4/LVLC_V11=0.008 MOD4/LVLC_I11=-0.009 MOD4/LVLC_V12=0.010 MOD4/LVLC_I12=-0.005 MOD4/LVLC_V13=0.016 MOD4/LVLC_I13=-0.001 MOD4/LVLC_V14=0.010 MOD4/LVLC_I14=-0.012 MOD4/LVLC_V15=0.012 MOD4/LVLC_I15=-0.004 MOD4/LVLC_V16=0.010 MOD4/LVLC_I16=-0.018 MOD4/LVLC_V17=-0.001 MOD4/LVLC_I17=-0.003 MOD4/LVLC_V18=0.011 MOD4/LVLC_I18=-0.006 MOD4/LVLC_V19=0.008 MOD4/LVLC_I19=-0.012 MOD4/LVLC_V20=0.003 MOD4/LVLC_I20=-0.002 MOD4/LVLC_V21=-0.006 MOD4/LVLC_I21=-0.004 MOD4/LVLC_V22=-0.001 MOD4/LVLC_I22=-0.013 MOD4/LVLC_V23=0.014 MOD4/LVLC_I23=-0.008 MOD4/LVLC_V24=0.008 MOD4/LVLC_I24=-0.004 MOD4/LVHC_V1=0.000 MOD4/LVHC_I1=-0.004 MOD4/LVHC_V2=0.000 MOD4/LVHC_I2=0.016 MOD4/LVHC_V3=0.000 MOD4/LVHC_I3=0.093 MOD4/LVHC_V4=0.000 MOD4/LVHC_I4=-0.104 MOD4/LVHC_V5=0.000 MOD4/LVHC_I5=-0.097 MOD4/LVHC_V6=0.000 MOD4/LVHC_I6=-0.069 MOD4/DINPUTS=00000000 MOD4/VCPU_OUTREG0=0 MOD4/VCPU_OUTREG1=0 MOD4/VCPU_OUTREG2=0 MOD4/VCPU_OUTREG3=0 MOD4/VCPU_OUTREG4=0 MOD4/VCPU_OUTREG5=0 MOD4/VCPU_OUTREG6=0 MOD4/VCPU_OUTREG7=0 MOD4/VCPU_OUTREG8=0 MOD4/VCPU_OUTREG9=0 MOD4/VCPU_OUTREG10=0 MOD4/VCPU_OUTREG11=0 MOD4/VCPU_OUTREG12=0 MOD4/VCPU_OUTREG13=0 MOD4/VCPU_OUTREG14=0 MOD4/VCPU_OUTREG15=0 MOD5/TEMP=30.812 MOD6/TEMP=30.437 MOD7/TEMP=30.562 MOD8/TEMP=30.687 MOD9/TEMP=31.375 MOD9/HVLC_V1=0.020 MOD9/HVLC_I1=-0.015 MOD9/HVLC_V2=0.020 MOD9/HVLC_I2=-0.012 MOD9/HVLC_V3=0.022 MOD9/HVLC_I3=-0.023 MOD9/HVLC_V4=0.021 MOD9/HVLC_I4=0.000 MOD9/HVLC_V5=0.021 MOD9/HVLC_I5=0.006 MOD9/HVLC_V6=0.021 MOD9/HVLC_I6=-0.004 MOD9/HVLC_V7=0.021 MOD9/HVLC_I7=-0.001 MOD9/HVLC_V8=0.022 MOD9/HVLC_I8=0.000 MOD9/HVLC_V9=0.022 MOD9/HVLC_I9=0.000 MOD9/HVLC_V10=0.022 MOD9/HVLC_I10=-0.010 MOD9/HVLC_V11=0.021 MOD9/HVLC_I11=-0.005 MOD9/HVLC_V12=0.021 MOD9/HVLC_I12=-0.013 MOD9/HVLC_V13=0.020 MOD9/HVLC_I13=-0.012 MOD9/HVLC_V14=0.022 MOD9/HVLC_I14=-0.008 MOD9/HVLC_V15=0.020 MOD9/HVLC_I15=-0.019 MOD9/HVLC_V16=0.021 MOD9/HVLC_I16=-0.012 MOD9/HVLC_V17=0.018 MOD9/HVLC_I17=0.002 MOD9/HVLC_V18=0.021 MOD9/HVLC_I18=-0.008 MOD9/HVLC_V19=0.023 MOD9/HVLC_I19=-0.010 MOD9/HVLC_V20=0.023 MOD9/HVLC_I20=-0.010 MOD9/HVLC_V21=0.023 MOD9/HVLC_I21=-0.018 MOD9/HVLC_V22=0.023 MOD9/HVLC_I22=-0.008 MOD9/HVLC_V23=0.022 MOD9/HVLC_I23=-0.013 MOD9/HVLC_V24=0.023 MOD9/HVLC_I24=-0.014 MOD9/HVHC_V1=0.001 MOD9/HVHC_I1=-0.032 MOD9/HVHC_V2=0.001 MOD9/HVHC_I2=0.042 MOD9/HVHC_V3=0.001 MOD9/HVHC_I3=-0.049 MOD9/HVHC_V4=0.001 MOD9/HVHC_I4=-0.073 MOD9/HVHC_V5=0.001 MOD9/HVHC_I5=-0.023 MOD9/HVHC_V6=0.001 MOD9/HVHC_I6=-0.116 MOD10/TEMP=29.562 MOD11/TEMP=29.312 '

        self.message('<'+id+reply)

if __name__ == '__main__':
    obj = {}
    daemon = SimpleFactory(ArchonFakeProtocol, obj)
    daemon.listen(4242)

    daemon._reactor.run()
